--Patient Population

CREATE VIEW qwu6617.McDonald_SU_PatientPop1 AS
SELECT
fp.Patient_DW_Id
,fp.Company_Code
,fp.Coid
,fp.Admission_Date
FROM EDWCDM_Views.Fact_Patient fp

INNER JOIN EDWCL_Views.Person_CL p
ON fp.Patient_Person_DW_Id = p.Person_DW_Id

INNER JOIN EDW_Pub_Views.Fact_Facility ff
ON fp.Coid = ff.Coid
AND ff.Division_Code = '00020' --Code for division
AND ff.LOB_Code = 'HOS' --Code for hospital
AND ff.COID_Status_Code = 'F' --Code for active facilities (i.e. not sold/closed)

INNER JOIN EDWCDM_PC_Views.Patient_Diagnosis  PD
ON	PD.Patient_DW_Id = FP.Patient_DW_Id  	   
AND PD.COID = FP.COID
AND PD.Diag_Mapped_Code NOT = 'Y'
AND pd.Diag_Cycle_Code = 'F'
AND pd.Diag_Rank_Num BETWEEN '1' AND '3'
AND (
	 (PD.Diag_Type_Code='0' AND pd.diag_code IN(
		'F10',
		'F101',
		'F1010',
		'F1011',
		'F1012',
		'F10120',
		'F10121',
		'F10129',
		'F1014',
		'F1015',
		'F10150',
		'F10151',
		'F10159',
		'F1018',
		'F10180',
		'F10181',
		'F10182',
		'F10188',
		'F1019',
		'F102',
		'F1020',
		'F1021',
		'F1022',
		'F10220',
		'F10221',
		'F10229',
		'F1023',
		'F10230',
		'F10231',
		'F10232',
		'F10239',
		'F1024',
		'F1025',
		'F10250',
		'F10251',
		'F10259',
		'F1026',
		'F1027',
		'F1028',
		'F10280',
		'F10281',
		'F10282',
		'F10288',
		'F1029',
		'F109',
		'F1092',
		'F10920',
		'F10921',
		'F10929',
		'F1094',
		'F1095',
		'F10950',
		'F10951',
		'F10959',
		'F1096',
		'F1097',
		'F1098',
		'F10980',
		'F10981',
		'F10982',
		'F10988',
		'F1099',
		'F11',
		'F111',
		'F1110',
		'F1111',
		'F1112',
		'F11120',
		'F11121',
		'F11122',
		'F11129',
		'F1114',
		'F1115',
		'F11150',
		'F11151',
		'F11159',
		'F1118',
		'F11181',
		'F11182',
		'F11188',
		'F1119',
		'F112',
		'F1120',
		'F1121',
		'F1122',
		'F11220',
		'F11221',
		'F11222',
		'F11229',
		'F1123',
		'F1124',
		'F1125',
		'F11250',
		'F11251',
		'F11259',
		'F1128',
		'F11281',
		'F11282',
		'F11288',
		'F1129',
		'F119',
		'F1190',
		'F1192',
		'F11920',
		'F11921',
		'F11922',
		'F11929',
		'F1193',
		'F1194',
		'F1195',
		'F11950',
		'F11951',
		'F11959',
		'F1198',
		'F11981',
		'F11982',
		'F11988',
		'F1199',
		'F12',
		'F121',
		'F1210',
		'F1211',
		'F1212',
		'F12120',
		'F12121',
		'F12122',
		'F12129',
		'F1215',
		'F12150',
		'F12151',
		'F12159',
		'F1218',
		'F12180',
		'F12188',
		'F1219',
		'F122',
		'F1220',
		'F1221',
		'F1222',
		'F12220',
		'F12221',
		'F12222',
		'F12229',
		'F1223',
		'F1225',
		'F12250',
		'F12251',
		'F12259',
		'F1228',
		'F12280',
		'F12288',
		'F1229',
		'F129',
		'F1290',
		'F1292',
		'F12920',
		'F12921',
		'F12922',
		'F12929',
		'F1293',
		'F1295',
		'F12950',
		'F12951',
		'F12959',
		'F1298',
		'F12980',
		'F12988',
		'F1299',
		'F13',
		'F131',
		'F1310',
		'F1311',
		'F1312',
		'F13120',
		'F13121',
		'F13129',
		'F1314',
		'F1315',
		'F13150',
		'F13151',
		'F13159',
		'F1318',
		'F13180',
		'F13181',
		'F13182',
		'F13188',
		'F1319',
		'F132',
		'F1320',
		'F1321',
		'F1322',
		'F13220',
		'F13221',
		'F13229',
		'F1323',
		'F13230',
		'F13231',
		'F13232',
		'F13239',
		'F1324',
		'F1325',
		'F13250',
		'F13251',
		'F13259',
		'F1326',
		'F1327',
		'F1328',
		'F13280',
		'F13281',
		'F13282',
		'F13288',
		'F1329',
		'F139',
		'F1390',
		'F1392',
		'F13920',
		'F13921',
		'F13929',
		'F1393',
		'F13930',
		'F13931',
		'F13932',
		'F13939',
		'F1394',
		'F1395',
		'F13950',
		'F13951',
		'F13959',
		'F1396',
		'F1397',
		'F1398',
		'F13980',
		'F13981',
		'F13982',
		'F13988',
		'F1399',
		'F14',
		'F141',
		'F1410',
		'F1411',
		'F1412',
		'F14120',
		'F14121',
		'F14122',
		'F14129',
		'F1414',
		'F1415',
		'F14150',
		'F14151',
		'F14159',
		'F1418',
		'F14180',
		'F14181',
		'F14182',
		'F14188',
		'F1419',
		'F142',
		'F1420',
		'F1421',
		'F1422',
		'F14220',
		'F14221',
		'F14222',
		'F14229',
		'F1423',
		'F1424',
		'F1425',
		'F14250',
		'F14251',
		'F14259',
		'F1428',
		'F14280',
		'F14281',
		'F14282',
		'F14288',
		'F1429',
		'F149',
		'F1490',
		'F1492',
		'F14920',
		'F14921',
		'F14922',
		'F14929',
		'F1494',
		'F1495',
		'F14950',
		'F14951',
		'F14959',
		'F1498',
		'F14980',
		'F14981',
		'F14982',
		'F14988',
		'F1499',
		'F15',
		'F151',
		'F1510',
		'F1511',
		'F1512',
		'F15120',
		'F15121',
		'F15122',
		'F15129',
		'F1514',
		'F1515',
		'F15150',
		'F15151',
		'F15159',
		'F1518',
		'F15180',
		'F15181',
		'F15182',
		'F15188',
		'F1519',
		'F152',
		'F1520',
		'F1521',
		'F1522',
		'F15220',
		'F15221',
		'F15222',
		'F15229',
		'F1523',
		'F1524',
		'F1525',
		'F15250',
		'F15251',
		'F15259',
		'F1528',
		'F15280',
		'F15281',
		'F15282',
		'F15288',
		'F1529',
		'F159',
		'F1590',
		'F1592',
		'F15920',
		'F15921',
		'F15922',
		'F15929',
		'F1593',
		'F1594',
		'F1595',
		'F15950',
		'F15951',
		'F15959',
		'F1598',
		'F15980',
		'F15981',
		'F15982',
		'F15988',
		'F1599',
		'F16',
		'F161',
		'F1610',
		'F1611',
		'F1612',
		'F16120',
		'F16121',
		'F16122',
		'F16129',
		'F1614',
		'F1615',
		'F16150',
		'F16151',
		'F16159',
		'F1618',
		'F16180',
		'F16183',
		'F16188',
		'F1619',
		'F162',
		'F1620',
		'F1621',
		'F1622',
		'F16220',
		'F16221',
		'F16229',
		'F1624',
		'F1625',
		'F16250',
		'F16251',
		'F16259',
		'F1628',
		'F16280',
		'F16283',
		'F16288',
		'F1629',
		'F169',
		'F1690',
		'F1692',
		'F16920',
		'F16921',
		'F16929',
		'F1694',
		'F1695',
		'F16950',
		'F16951',
		'F16959',
		'F1698',
		'F16980',
		'F16983',
		'F16988',
		'F1699',
		'F17',
		'F172',
		'F1720',
		'F17200',
		'F17201',
		'F17203',
		'F17208',
		'F17209',
		'F1721',
		'F17210',
		'F17211',
		'F17213',
		'F17218',
		'F17219',
		'F1722',
		'F17220',
		'F17221',
		'F17223',
		'F17228',
		'F17229',
		'F1729',
		'F17290',
		'F17291',
		'F17293',
		'F17298',
		'F17299',
		'F18',
		'F181',
		'F1810',
		'F1811',
		'F1812',
		'F18120',
		'F18121',
		'F18129',
		'F1814',
		'F1815',
		'F18150',
		'F18151',
		'F18159',
		'F1817',
		'F1818',
		'F18180',
		'F18188',
		'F1819',
		'F182',
		'F1820',
		'F1821',
		'F1822',
		'F18220',
		'F18221',
		'F18229',
		'F1824',
		'F1825',
		'F18250',
		'F18251',
		'F18259',
		'F1827',
		'F1828',
		'F18280',
		'F18288',
		'F1829',
		'F189',
		'F1890',
		'F1892',
		'F18920',
		'F18921',
		'F18929',
		'F1894',
		'F1895',
		'F18950',
		'F18951',
		'F18959',
		'F1897',
		'F1898',
		'F18980',
		'F18988',
		'F1899',
		'F19',
		'F191',
		'F1910',
		'F1911',
		'F1912',
		'F19120',
		'F19121',
		'F19122',
		'F19129',
		'F1914',
		'F1915',
		'F19150',
		'F19151',
		'F19159',
		'F1916',
		'F1917',
		'F1918',
		'F19180',
		'F19181',
		'F19182',
		'F19188',
		'F1919',
		'F192',
		'F1920',
		'F1921',
		'F1922',
		'F19220',
		'F19221',
		'F19222',
		'F19229',
		'F1923',
		'F19230',
		'F19231',
		'F19232',
		'F19239',
		'F1924',
		'F1925',
		'F19250',
		'F19251',
		'F19259',
		'F1926',
		'F1927',
		'F1928',
		'F19280',
		'F19281',
		'F19282',
		'F19288',
		'F1929',
		'F199',
		'F1990',
		'F1992',
		'F19920',
		'F19921',
		'F19922',
		'F19929',
		'F1993',
		'F19930',
		'F19931',
		'F19932',
		'F19939',
		'F1994',
		'F1995',
		'F19950',
		'F19951',
		'F19959',
		'F1996',
		'F1997',
		'F1998',
		'F19980',
		'F19981',
		'F19982',
		'F19988',
		'F1999'

		)))


INNER JOIN EDWCL_Views.Clinical_Registration reg
	ON fp.Patient_DW_Id = reg.Patient_DW_Id
	AND fp.CoID = reg.CoID
	AND fp.company_code = reg.company_code 

INNER JOIN qwu6617.Alt_Transfer_Table cpt 
	ON fp.patient_dw_id = cpt.patient_dw_id 
	AND fp.coid = cpt.coid

LEFT JOIN EDWCL_VIEWS.Clinical_Facility_Location cfl
	ON cpt.COID = cfl.COID
	AND cpt.Location_mnemonic_cs = cfl.Location_mnemonic

LEFT JOIN EDWCL_Views.Ref_Nomenclature_Code_Map ncm
	ON cfl.COID = ncm.COID
	AND cfl.Nomenclature_Code = ncm.Nomenclature_Code
	AND ncm.Active_Ind = 'Y'
	AND ncm.Standard_Code_Type = 'SNOMED_CT'

LEFT JOIN EDWCDM_Views.SNOMED_CD sc
	ON ncm.Standard_Code_Text = sc.SNOMED_CD
	AND sc.VLD_TO_TS = '9999-12-31 00:00:00'


WHERE fp.Admission_Date BETWEEN '2019-02-01' AND '2019-05-31' --update date
AND fp.Discharge_Date BETWEEN '2019-02-01' AND '2019-05-31'  --update date
AND ((Cast((Cast((fp.Admission_Date(Format'YYYY-MM')) AS CHAR(7)) || '-01') AS DATE) - Cast((Cast((p.Person_Birth_Date(Format'YYYY-MM')) AS CHAR(7)) || '-01') AS DATE))/365) BETWEEN '0' AND '115' --update age
AND fp.Company_Code='H'
AND fp.final_bill_date <> '0001-01-01'
AND fp.final_bill_date IS NOT NULL
AND sc.SNOMED_CD IN( '224884006', '285201006', '440654001')



GROUP BY 1,2,3,4